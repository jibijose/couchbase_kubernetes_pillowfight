---
apiVersion: batch/v1
kind: Job
metadata:
    name: {{ .Values.pillowfight.name}}
    namespace: {{ .Values.pillowfight.namespace}}
spec:
    backoffLimit: 0
    parallelism: {{ .Values.pillowfight.parallelism}}
    completions: {{ .Values.pillowfight.completions}}
    template:
        metadata:
            labels:
                app: {{ .Values.pillowfight.name}}
                version: v1
        spec:
            restartPolicy: Never
            containers:
              - image: registry.hub.docker.com/jibijose/pillowfight:latest
                imagePullPolicy: {{ .Values.pillowfight.imagePullPolicy}}
                name: {{ .Values.pillowfight.name}}
                resources:
                    requests:
                        memory: {{ .Values.pillowfight.requests.memory}}
                        cpu: {{ .Values.pillowfight.requests.cpu}}
                    limits:
                        memory: {{ .Values.pillowfight.limits.memory}}
                        cpu: {{ .Values.pillowfight.limits.cpu}}
                env:
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                  - name: CB_HOST
                    value: {{ .Values.pillowfight.env.cb_host}}
                  - name: CB_BUCKET
                    value: {{ .Values.pillowfight.env.cb_bucket}}
                  - name: CB_USER
                    value: {{ .Values.pillowfight.env.cb_user}}
                  - name: CB_PASSWORD
                    value: "{{ .Values.pillowfight.env.cb_password}}"
                  - name: MIN_SIZE
                    value: "{{ .Values.pillowfight.env.min_size}}"
                  - name: MAX_SIZE
                    value: "{{ .Values.pillowfight.env.max_size}}"
                  - name: THREAD_COUNT
                    value: "{{ .Values.pillowfight.env.thread_count}}"
                  - name: ITEMS_COUNT
                    value: "{{ .Values.pillowfight.env.items_count}}"
                  - name: MUTATION_PERCENTAGE
                    value: "{{ .Values.pillowfight.env.mutation_percentage}}"
                  - name: BATCH_SIZE
                    value: "{{ .Values.pillowfight.env.batch_size}}"
                  - name: PERSIST_TO
                    value: "{{ .Values.pillowfight.env.persist_to}}"
                  - name: REPLICATE_TO
                    value: "{{ .Values.pillowfight.env.replicate_to}}"
                  - name: PATH_COUNT
                    value: "{{ .Values.pillowfight.env.path_count}}"
                  - name: RATE_LIMIT
                    value: "{{ .Values.pillowfight.env.rate_limit}}"
                  - name: JSON_FLAG
                    value: "{{ .Values.pillowfight.env.json_flag}}"
                  - name: SUBDOC_FLAG
                    value: "{{ .Values.pillowfight.env.subdoc_flag}}"
                  - name: COMPRESS_FLAG
                    value: "{{ .Values.pillowfight.env.compress_flag}}"
                  - name: TIMINGS_FLAG
                    value: "{{ .Values.pillowfight.env.timings_flag}}"
                  - name: RANDOM_BODY
                    value: "{{ .Values.pillowfight.env.random_body_flag}}"
                  - name: ADDL_FLAGS
                    value: "{{ .Values.pillowfight.env.addl_flags}}"
                  
